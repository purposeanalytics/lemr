---
title: "Story 2"
date: "9/21/2021"
output:
  github_document: default
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r library}
library(dplyr)
library(readr)
library(ggplot2)
library(lemr)
library(purrr)
library(tidyr)
library(ggtern)
library(ggrepel)
devtools::load_all()
```
 
# Story 2 Concept
 
1. omg look at this app, you can click these layers!

    * **Concept: the horseshoe is where we start to see the line between rich and poor**
      
      * proximity?!? everything is downtown, where its expensive
    
      * evictions?!? oh no poor neighbourhoods seem more

2. toronto is sort of "three cities" where the rich live with the rich, poor with the poor, and the middle with the middle [if such a thing exists], but historically, it used to be these mixed income neighbourhoods with maybe some exceptions like rosedale or whatever

    * **Concept: we're trying to show this with evictions & housing needs + LEMR availability**

3. so then proximity can sort of show the current story of the poor

    * **Concept: we're trying to show these two distinct clusters of neighbourhoods**
  
      * poor means you can either live with low access to service _OR_ in toronto community housing
  
    


```{r}
neighbourhood_aggregate <- lemr::neighbourhood_aggregate %>%
  transpose()

neighbourhood_aggregate <- neighbourhood_aggregate[c("amenity_density", "core_housing_need", "rental_supply", "lem", "number_of_buildings", "average_total_income", "unaffordable_housing", "evictions", "average_renter_shelter_cost")] %>%
  map_depth(.depth = 2, as_tibble) %>%
  map(~ .x %>% bind_rows(.id = "neighbourhood"))
```

```{r}
# amenity density
adn <- neighbourhood_aggregate[["amenity_density"]] %>% pivot_wider(names_from = group, values_from = prop)
```

```{r}
# core housing needs density
chn <- neighbourhood_aggregate[["core_housing_need"]] %>% rename(core_housing_need = value)
```

```{r}
# rental supply
rsn <- neighbourhood_aggregate[["rental_supply"]] %>% select(group, neighbourhood, value, prop, market_prop) %>% 
  pivot_wider(names_from = group, values_from = c(value, prop, market_prop))
```

```{r}
# low end of market breakdown
lem <- neighbourhood_aggregate[["lem"]] %>% 
  pivot_wider(names_from = Bedrooms, values_from = c(`Deeply Affordable`, `Very Affordable`, `Total`), names_repair = 'minimal')
```

```{r}
# number of buildings
nb <- neighbourhood_aggregate[["number_of_buildings"]] %>% rename(number_of_buildings = value)
```

```{r}
# total income
ati <- neighbourhood_aggregate[["average_total_income"]] %>% 
  pivot_wider(names_from = group, values_from = c(value))
```

```{r}
# unaffordable percent
uh <- neighbourhood_aggregate[["unaffordable_housing"]] %>% rename(unaffordable_housing = value)
```

```{r}
# average shelter cost
arsc <- neighbourhood_aggregate[["average_renter_shelter_cost"]] %>% rename(average_renter_shelter_cost = value) 
```

```{r}
# eviction rate
ev <- neighbourhood_aggregate[["evictions"]] %>% rename(eviction_rate = value)
```

```{r dataset}
proximity_layers <- adn %>% 
  inner_join(arsc, by = 'neighbourhood') %>% 
  inner_join(ati, by = 'neighbourhood') %>% 
  inner_join(lem, by = 'neighbourhood') %>% 
  inner_join(nb, by = 'neighbourhood') %>% 
  inner_join(rsn, by = 'neighbourhood') %>% 
  inner_join(uh, by = 'neighbourhood') %>% 
  inner_join(ev, by = 'neighbourhood') %>% 
  inner_join(chn, by = 'neighbourhood')
```

## lowend similarities

```{r}
reinf_shap <- proximity_layers %>% 
  select(neighbourhood, Total_Total, eviction_rate, unaffordable_housing, `market_prop_Other Non-Market`, core_housing_need) %>%
  arrange(desc(Total_Total))
```
 
```{r results='hide'}
#dev or redo
plotly::ggplotly(
  ggplot(reinf_shap, aes(core_housing_need, `eviction_rate`, colour = `market_prop_Other Non-Market`)) +
    geom_point(aes(size = Total_Total, text = neighbourhood)) +
    ggrepel::geom_label_repel(data = reinf_shap, aes(label=neighbourhood), size= 2.5) +
    #scale_color_manual(values = c("TRUE" = "#08569a", "FALSE" = "grey")) +
    geom_vline(xintercept = .365) +
    geom_hline(yintercept = .043) +
    #xlim(0, .7) +
    #ylim(0, .7) +
    #geom_abline(a = 1) +
    theme_bw()+
    theme(legend.position = 'None'),
    )
```
 


```{r dpi = 300}
reinf_plot <- reinf_shap %>% mutate(top3 = neighbourhood %in% c('Dovercourt-Wallace Emerson-Junction','Woburn',
                                    'Thorncliffe Park','West Humber-Clairville','York University Heights'))

ggplot(reinf_plot, aes(core_housing_need, `eviction_rate`, colour = `top3`)) +
    geom_point(aes(size = Total_Total, text = neighbourhood)) +
    ggrepel::geom_label_repel(data = reinf_plot %>% filter(top3), aes(label=neighbourhood), size= 2.5) +
    scale_color_manual(values = c("TRUE" = "#08569a", "FALSE" = "grey")) +
    geom_vline(xintercept = .365) +
    geom_text(aes(x=.355, label="City Average", y=0.13), angle=90) +
    geom_hline(yintercept = .043) +
    geom_text(aes(0.075,.043,label = 'City Average', vjust = -1)) +
    theme_bw()+
    theme(legend.position = 'None')
```

```{r}
kableExtra::kable(reinf_plot %>% filter(top3) %>% select(-top3) %>% 
  mutate(eviction_rate = scales::percent(eviction_rate, accuracy = 0.1), 
         unaffordable_housing = scales::percent(unaffordable_housing, accuracy = 0.1),
         `market_prop_Other Non-Market` = scales::percent(`market_prop_Other Non-Market`, accuracy = 0.1),
         core_housing_need = scales::percent(core_housing_need, accuracy = 0.1)) %>% janitor::clean_names('title'),
  caption = "Highlighted Neighbourhoods", booktabs = TRUE, linesep = "") %>%
  kableExtra::kable_styling(latex_options = c("striped", "HOLD_position"))

```


## proximity

```{r}
pos_tab <- proximity_layers %>% 
  select(neighbourhood, High, Medium, Low, `Total_Total`, `value_Toronto Community Housing`) %>% 
  mutate(HighMedium = High+Medium) %>% 
  relocate(HighMedium, .before = High) %>% 
  rename(TCHC = `value_Toronto Community Housing`, TotalLEM = Total_Total)
```

### total

```{r}
HighMedHighLem <- pos_tab %>% filter(TotalLEM > 250)  %>% 
  arrange(-HighMedium, -TotalLEM) %>% slice(1:5)

kableExtra::kable(HighMedHighLem %>% 
  mutate(HighMedium = scales::percent(HighMedium, accuracy = 0.1), 
       High = scales::percent(High, accuracy = 0.1), 
       Medium = scales::percent(Medium, accuracy = 0.1),
       Low = scales::percent(Low, accuracy = 0.1)) %>% janitor::clean_names('title'),
caption = "Top 5 neighbourhoods by High Medium with at least 250 Total LEM", booktabs = TRUE, linesep = "") %>%
kableExtra::kable_styling(latex_options = c("striped", "HOLD_position"))

```

```{r}
pos_tab %>% filter(TotalLEM > 250) %>% 
  arrange(-Low, -TotalLEM) %>% slice(1:5)
```

```{r}
pos_tab %>% 
  arrange(-HighMedium, TotalLEM, -High) %>% slice(1:5)
```

```{r}

pos_tab %>% filter(TCHC < 475) %>% 
  arrange(-HighMedium, TotalLEM, -High) %>% slice(1:5)

```

```{r}
pos_tab %>% arrange(-TotalLEM, -Low) %>% slice(1:5)
```

```{r dpi = 300}
pos_tab_plot <- pos_tab %>% mutate(top3 = neighbourhood %in% c('North St. James Town','Regent Park','Kensington-Chinatown',
                                    'Newtonbrook East','Bathurst Manor','St.Andrew-Windfields', 
                                    'Woburn','West Humber-Clairville', 'North Riverdale'))
  
ggplot(pos_tab_plot %>% arrange(top3), aes(y = TotalLEM, x = HighMedium, colour = top3)) + 
  geom_point(aes(size = High, text = neighbourhood, postion = 'jitter')) + 
  ggrepel::geom_label_repel(data = pos_tab_plot %>% filter(top3), aes(label=neighbourhood), size= 2.5) +
  scale_color_manual(values = c("TRUE" = "#08569a", "FALSE" = "grey")) +
  theme_bw()+
  theme(legend.position = 'None')
```
### prop

```{r}
pos_tab_prop <- proximity_layers %>% 
  mutate(Stock = (value_Apartment+`value_Non-Apartment`+value_Condo+`value_Non-Condo`+`value_Toronto Community Housing`+`value_Other Non-Market`),
    LEMProp = Total_Total/Stock) %>% 
  select(neighbourhood, High, Medium, Low, LEMProp, Stock, Total_Total, `value_Toronto Community Housing`, `value_Other Non-Market`) %>% 
  mutate(HighMedium = High+Medium) %>% 
  relocate(HighMedium, .before = High) %>% 
  rename(TCHC = `value_Toronto Community Housing`, NonMarket = `value_Other Non-Market`, TotalLEM = Total_Total)
```

```{r}
pos_tab_prop  %>% 
  arrange(-HighMedium, -LEMProp) 
```

```{r}
pos_tab_prop %>% 
  arrange(-Low, -LEMProp) 
```

```{r}
pos_tab_prop %>% filter(TCHC < 475) %>% 
  arrange(-HighMedium, LEMProp, -High) 
```

```{r}
pos_tab_prop %>% 
  arrange(-HighMedium, LEMProp, -High) 

```

```{r}
pos_tab_prop %>% filter(Stock > 1937) %>% 
  arrange(-LEMProp, -Low)
```

```{r dpi = 300}
pos_tab_prop_plot <- pos_tab_prop %>% mutate(top3 = neighbourhood %in% c('Moss Park','Regent Park','Mount Pleasant West',
                                    'Church-Yonge Corridor','Rouge',
                                    'West Humber-Clairville', 'Clairlea-Birchmount'))
  
ggplot(pos_tab_prop_plot %>% filter(Stock > 1937) %>% arrange(top3), aes(y = LEMProp, x = Low, colour = top3)) + 
  geom_point(size = 3, aes(color = top3)) +
  geom_label_repel(data = pos_tab_prop_plot %>% filter(top3), aes(label = neighbourhood), size = 2.5
                   #, family = "Lato"
                   ) +
  scale_color_manual(values = c("TRUE" = main_colour, "FALSE" = grey_colour)) +
  scale_y_continuous(labels = scales::percent, limits = c(0, .3), name = "Proportion of LEM") + 
  scale_x_continuous(labels = scales::percent, limits = c(0, 1), name = "% of Low Proximity") + 
  labs(title = "A Shorter Title than Last Time") + 
  #theme_minimal(base_family = "Lato") +
  theme(legend.position = "none",
        plot.title.position = "plot")
```



### ternary

```{r}
prox_pick <- proximity_layers %>% 
  select(neighbourhood, High, Medium, Low, number_of_buildings, `Total_Total`, `prop_Toronto Community Housing`, eviction_rate) %>% 
  pivot_longer(cols = c(High, Medium, Low))
```

```{r results='hide'}
#dev only
graph_prox <- prox_pick %>% filter(Total_Total > 100, number_of_buildings >= 10)


plotly::ggplotly(
  ggplot(graph_prox, aes(value, `Total_Total`, colour = eviction_rate)) +
    geom_point(aes(size = 2, text = neighbourhood)) +
    ggrepel::geom_label_repel(data = graph_prox, aes(label=neighbourhood), size= 2.5) +
    #scale_color_manual(values = c("TRUE" = "#08569a", "FALSE" = "grey")) +
    geom_hline(yintercept = 250) +
    facet_wrap(~name) +
    
    theme_bw()+
    theme(legend.position = 'None')
    )
```


```{r eval = FALSE}
triangle <- tibble(polygon_x = c(0,1,.5), polygon_y = c(0,0, sqrt(3)/2))
texts <- tibble(
  x = c(-.025,1.05,.5),
  y = c(0,0,sqrt(3)/2 + .03),
  text = c("Low", "Medium","High"))

woburn <- prox_pick %>% filter(neighbourhood == 'Annex')

pos <-  woburn %>% select("name","value", "neighbourhood", "Total_Total")


positions <- tibble(
  neighbourhood = pos$neighbourhood,
  Total_Total = pos$Total_Total,
  x = as.numeric((1/2) * (((2*pos[which(pos$name == "Medium"),"value"]) + pos[which(pos$name == "High"),"value"])/
                            (pos[which(pos$name == "Low"),"value"] + pos[which(pos$name == "Medium"),"value"]
                             + pos[which(pos$name == "High"),"value"]))),
  y = as.numeric(((sqrt(3)/2) * (pos[which(pos$name == "High"),"value"] / 
                            (pos[which(pos$name == "Low"),"value"] + pos[which(pos$name == "Medium"),"value"]
                             + pos[which(pos$name == "High"),"value"])))))
           
ggplot(positions, aes(x = x, y = y)) +
  geom_point(aes(size = Total_Total/100)) +
  geom_text(label = positions$neighbourhood) +
  geom_text(data = texts, aes(label = text)) +
  geom_polygon(data = triangle,aes(x = polygon_x, y=polygon_y), fill = NA,colour = 'black') +
  xlim(-.1,1.1) +
  ylim(-.1,1.1) +
  theme_void()

```

```{r}
triangle <- tibble(polygon_x = c(0,1,.5), polygon_y = c(0,0, sqrt(3)/2))
texts <- tibble(
  x = c(-.025,1.05,.5),
  y = c(0,0,sqrt(3)/2 + .03),
  text = c("Low", "Medium","High"))

pos <- proximity_layers %>% 
  select(neighbourhood, High, Medium, Low, `Total_Total`, number_of_buildings) #%>% filter(neighbourhood == 'Annex')

ternary <- as_tibble()
for (i in seq(from = 1, to = nrow(pos))){
  positions <- tibble(
    neighbourhood = pos$neighbourhood[i],
    number_of_buildings = pos$number_of_buildings[i],
    Total_Total = pos$Total_Total[i],
    x = as.numeric((1/2) * (((2*pos$Medium[i]) + pos$High[i])/
                              (pos$Low[i] + pos$Medium[i] + pos$High[i]))),
    y = as.numeric(((sqrt(3)/2) * (pos$High[i] / 
                              (pos$Low[i] + pos$Medium[i] + pos$High[i]))))
    )
  for (i in nrow(positions)) {
    ternary <- rbind(ternary, positions)}
}
# ternary
```

```{r dpi = 300}
#dev
ternary_plot <- ternary %>% filter(Total_Total >= 225)

ggplot(ternary_plot, aes(x = x, y = y)) +
  geom_point(aes(colour = Total_Total)) +
  ggrepel::geom_label_repel(data = ternary_plot, aes(label=neighbourhood), size= 1) +
  #geom_text(label = ternary_plot$neighbourhood, size = 1) +
  geom_text(data = texts, aes(label = text)) +
  geom_polygon(data = triangle,aes(x = polygon_x, y=polygon_y), fill = NA,colour = 'black') +
  xlim(-.1,1.1) +
  ylim(-.1,1.1) +
  theme_void()

```

```{r}
kableExtra::kable(pos %>% filter(Total_Total >= 225) %>% 
  mutate(High = scales::percent(High, accuracy = 0.1), 
         Medium = scales::percent(Medium, accuracy = 0.1),
         Low = scales::percent(Low, accuracy = 0.1)) %>% janitor::clean_names('title'),
  caption = "Filtered @225 total_total neighbourhoods", booktabs = TRUE, linesep = "") %>%
  kableExtra::kable_styling(latex_options = c("striped", "HOLD_position"))

```



```{r dpi = 300}
ternary_plot <- pos %>% filter(Total_Total > 250) %>% 
  mutate(top3 = neighbourhood %in% c('Dovercourt-Wallace Emerson-Junction','Woburn', 'Weston',
                                    'Thorncliffe Park','West Humber-Clairville','York University Heights'))

ggtern::ggtern(data=ternary_plot,aes(x=Low,y=High, z=Medium)) +
  geom_point(aes(colour = Total_Total), size =2.5) +
  #ggrepel::geom_label_repel(data = ternary_plot, aes(label=neighbourhood), size= 2) +
  geom_text(data = ternary_plot %>% filter(top3)
            , aes(label = paste0(neighbourhood,':',Total_Total)), size = 2, vjust= -3, check_overlap = FALSE,position=position_jitter_tern(y = 0.08)) +
  theme_light() +
  theme_nomask() +
  theme_showarrows() +
  tern_anticlockwise() + 
  theme_nolabels()
```

```{r}
kableExtra::kable(ternary_plot %>% filter(top3) %>% select(-top3) %>% 
  mutate(High = scales::percent(High, accuracy = 0.1), 
         Medium = scales::percent(Medium, accuracy = 0.1),
         Low = scales::percent(Low, accuracy = 0.1)) %>% janitor::clean_names('title'),
  caption = "Highlighted Neighbourhoods", booktabs = TRUE, linesep = "") %>%
  kableExtra::kable_styling(latex_options = c("striped", "HOLD_position"))

```


## toronto housing

### in progressssssssss :) 

```{r}
moss_park <- proximity_layers %>% filter(neighbourhood == 'Moss Park') %>% 
  gather(key = var_name, value = value, 2:ncol(proximity_layers)) %>% 
    spread_(key = names(proximity_layers)[1],value = 'value') #%>% View()
``` 

```{r}
commun_housing <- proximity_layers %>% 
  select(neighbourhood, Total_Total, eviction_rate, unaffordable_housing,core_housing_need,
         `market_prop_Other Non-Market`,
         `value_Toronto Community Housing`,  `prop_Toronto Community Housing`, 
         `value_Other Non-Market`, `prop_Other Non-Market`,
         High, Medium, Low) %>%
  mutate(`market_value_Other Non-Market` = `value_Toronto Community Housing`+`value_Other Non-Market`) %>% 
  relocate(`market_value_Other Non-Market`, .before = `market_prop_Other Non-Market`) %>% 
  janitor::clean_names()
```

```{r results='hide'}
commun_housing_plot <- commun_housing %>% filter(total_total > 250 | market_value_other_non_market > 650) %>% 
  mutate(top3 = neighbourhood %in% c('Dovercourt-Wallace Emerson-Junction','Woburn',
                                    'Thorncliffe Park','West Humber-Clairville','York University Heights',
                                    'Moss Park'))


#plotly::ggplotly(
  ggplot(data = commun_housing_plot, aes(x = market_value_other_non_market, y = total_total, colour = top3)) +
    geom_point(aes(size = total_total, text = neighbourhood)) + 
    ggrepel::geom_label_repel(data = commun_housing_plot %>% filter(top3)
                              , aes(label=neighbourhood), size= 2.5) +
    scale_color_manual(values = c("TRUE" = "#08569a", "FALSE" = "grey")) +
    theme_bw() +
    theme(legend.position = 'None')
    #)
  
  
```

```{r dpi = 300}
ternary_plot_comm <- commun_housing %>% 
  filter(total_total > 250 | market_value_other_non_market > 650) %>% 
  mutate(top3 = neighbourhood %in% c('Dovercourt-Wallace Emerson-Junction','Woburn', 'Weston',
                                    'Thorncliffe Park','West Humber-Clairville','York University Heights'))

ggtern::ggtern(data=ternary_plot_comm,aes(x=low,y=high, z=medium)) +
  geom_point(aes(size = total_total, colour = market_prop_other_non_market)) +
  #ggrepel::geom_label_repel(data = ternary_plot, aes(label=neighbourhood), size= 2) +
  geom_text(data = ternary_plot_comm %>% filter(top3)
            , aes(label = paste0(neighbourhood,'\n',total_total,' : ', market_value_other_non_market)), size = 2, vjust= -.5, check_overlap = FALSE,position=position_jitter_tern(y = 0.08)) +
  theme_light() +
  theme_nomask() +
  theme_showarrows() +
  tern_anticlockwise() + 
  theme_nolabels() +
  theme(legend.position="none")
```

