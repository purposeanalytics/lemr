---
title: "Stories1"
date: "9/16/2021"
output:
  github_document: default
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r library}
library(dplyr)
library(readr)
library(ggplot2)
library(sf)
```

```{r load}
buildings_layers <- lemur::buildings %>% as_tibble() %>% 
  filter(apartment, property_type == 'Privately owned')
```


```{r}
agi_tdf <- buildings_layers %>% 
  select(bing_address, neighbourhood, agi, tdf, tdf_year, reduced_increase_by) %>% 
  #tidyr::separate_rows(tdf_year, reduced_increase_by, sep = ',') %>% 
  group_by(neighbourhood) %>% mutate(reduced_increase_by = as.numeric(gsub("%", "", reduced_increase_by, fixed = TRUE))/100) %>%  
  summarise(Count = n_distinct(bing_address), AGI = sum(agi, na.rm = TRUE), 
            TDF = sum(tdf, na.rm = TRUE), 
            reduced_increase_by_avg = mean(reduced_increase_by, na.rm = TRUE)) %>%  
  mutate(agi_ratio = AGI/Count, tdf_ratio = TDF/AGI) %>% 
  mutate_at(vars(reduced_increase_by_avg), ~replace(., is.nan(.), 0)) %>% 
  filter(Count > 10 & AGI > 8) %>% arrange(desc(reduced_increase_by_avg)) 
agi_tdf
```

```{r eval = FALSE}
agi_tdf <- mutate(agi_tdf, top3 = rank(-agi_ratio) %in% 1:5)

plotly::ggplotly(
  ggplot(agi_tdf, aes(agi_ratio, tdf_ratio)) +
    geom_point(size = agi_tdf$Count /10, aes(color = top3, fill = neighbourhood)) +
    ggrepel::geom_label_repel(data = agi_tdf %>% filter(top3), aes(label=neighbourhood), size= 2.5) +
    scale_color_manual(values = c("TRUE" = "#08569a", "FALSE" = "grey")) +
    theme_bw()+
    theme(legend.position = 'None')
    )
```


```{r dpi = 300}

agi_tdf <- agi_tdf %>% mutate(top3 = case_when(neighbourhood == 'Yonge-St.Clair' ~ TRUE,
                                               neighbourhood == 'Broadview North' ~ TRUE,
                                               neighbourhood == 'Mimico (includes Humber Bay Shores)' ~ TRUE,
                                               TRUE ~ FALSE))
#plotly::ggplotly(
  ggplot(agi_tdf, aes(agi_ratio, tdf_ratio)) +
    geom_point(size = 3, aes(color = top3, fill = neighbourhood)) +
    ggrepel::geom_label_repel(data = agi_tdf %>% filter(top3), aes(label=neighbourhood), size= 2.5) +
    scale_color_manual(values = c("TRUE" = "#08569a", "FALSE" = "grey")) +
    theme_bw()+
    theme(legend.position = 'None')
    #)

```


```{r}

kableExtra::kable(agi_tdf %>% filter(top3 == TRUE) %>% select(-top3, -reduced_increase_by_avg) %>% 
                    mutate(agi_ratio = sprintf("%0.1f%%", agi_ratio * 100), tdf_ratio = sprintf("%0.1f%%", tdf_ratio * 100))
                  , caption="Highlighted Neighbourhoods", booktabs = TRUE, linesep= "") %>% 
  kableExtra::kable_styling(latex_options = c("striped", "HOLD_position"))
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```

