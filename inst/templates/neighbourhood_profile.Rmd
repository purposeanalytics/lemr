---
params:
  level: neighbourhood
  neighbourhood: Danforth
output:
  html_document:
    df_print: paged
    css: ../app/www/style.css
---

```{r setup, include=FALSE}
library(lemur)
library(htmltools)
library(knitr)
library(leaflet)
library(mapview)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, dpi = 300, out.width = "100%", fig.pos = "!H", out.height = "2in")

distribution_height <- "200px"

html_output <- is_html_output()
output <- ifelse(html_output, "html", "pdf")

if (html_output) {
  output <- "html"
  format_paragraph <- htmltools::p
} else {
  output <- "pdf"
  format_paragraph <- function(x) {
    cat(x, "\n")
  }
}

level <- params$level
neighbourhood <- params$neighbourhood
compare <- level == "neighbourhood"

title <- switch(level,
  "neighbourhood" = neighbourhood,
  "city" = "City of Toronto"
)

dataset <- lemur:::determine_dataset_from_level(level, neighbourhood)
```

---
title: `r title`
---

```{r map}
neighbourhood_data <- lemur::neighbourhoods %>%
  dplyr::filter(neighbourhood == !!neighbourhood)

bbox <- sf::st_bbox(neighbourhood_data) %>%
  unname()

neighbourhood_buildings <- lemur::buildings %>%
  dplyr::filter(neighbourhood == !!neighbourhood)

add_circle_layer <- function(map, data, colour) {
  map %>%
    addCircles(data = data, color = "white", fillColor = colour, stroke = TRUE, opacity = 1, fillOpacity = 1, weight = 0.5, radius = 20)
}

m <- leaflet(data = neighbourhood_data, options = leafletOptions(zoomControl = FALSE, attributionControl = FALSE)) %>%
  addTiles() %>%
  addPolygons(color = lemur:::main_colour, fill = FALSE, opacity = 1) %>%
  fitBounds(bbox[1], bbox[2], bbox[3], bbox[4]) %>%
  add_circle_layer(
    data = neighbourhood_buildings %>%
      dplyr::filter(apartment),
    colour = lemur:::layer_colours[["apartment_buildings"]]
  ) %>%
  add_circle_layer(
    data = neighbourhood_buildings %>%
      dplyr::filter(eviction_hearing),
    colour = lemur:::layer_colours[["evictions_hearings"]]
  ) %>%
  add_circle_layer(
    data = neighbourhood_buildings %>%
      dplyr::filter(agi),
    colour = lemur:::layer_colours[["agi"]]
  ) %>%
  add_circle_layer(data = neighbourhood_buildings %>%
    dplyr::filter(tdf), colour = lemur:::layer_colours[["tdf"]]) %>%
  addLegend(
    colors = unname(lemur:::layer_colours),
    labels = c("Apartment buildings", "Evictions hearings", "Above Guideline Increase applications", "Tenant Defense Fund grants"),
    opacity = 1,
    position = "bottomright"
  )

mapshot(m, file = here::here("inst", "templates", "maps", glue::glue("{neighbourhood}.png")))
```

```{r map-include, fig.height = 10, out.height = NULL}
knitr::include_graphics(here::here("inst", "templates", "maps", glue::glue("{neighbourhood}.png")))
```

```{r households}
glue::glue('Households: {scales::comma(dataset[["households"]])}') %>%
  lemur:::bigger_padded()
```

```{r population}
glue::glue('Population: {scales::comma(dataset[["population"]])}') %>%
  lemur:::bigger_padded()
```

## Apartment buildings

```{r apartment-buildings, opts.label = "distribution", fig.alt = lemur:::number_of_apartments_plot_alt_text(level, neighbourhood)}
number_of_apartments <- lemur:::get_measure(dataset, "number_of_apartments")
number_of_apartments_formatted <- lemur:::format_measure(number_of_apartments, "number_of_apartments")

number_of_units <- lemur:::get_measure(dataset, "number_of_units")
number_of_units_formatted <- lemur:::format_measure(number_of_units, "number_of_units")

lemur:::number_of_apartments_number(number_of_apartments_formatted, number_of_units_formatted) %>%
  lemur:::bigger_padded()

lemur:::number_of_apartments_description(level, neighbourhood, number_of_apartments, number_of_apartments_formatted) %>%
  format_paragraph() %>%
  lemur:::bigger_padded()

lemur:::number_of_apartments_plot(dataset, compare, height = distribution_height)
```

```{r apartment-building-units, opts.label = "distribution", fig.alt = lemur:::number_of_units_plot_alt_text(level, neighbourhood)}
lemur:::number_of_units_description(level, neighbourhood, number_of_units, number_of_units_formatted) %>%
  format_paragraph() %>%
  lemur:::bigger_padded()

lemur:::number_of_units_plot(dataset, compare, height = distribution_height)
```

## RentSafeTO evaluation scores

```{r apartment-building-evaluation, opts.label = "distribution", fig.alt = lemur:::apartment_building_evaluation_plot_alt_text(level, neighbourhood)}
apartment_building_evaluation <- lemur:::get_measure(dataset, "apartment_building_evaluation")
apartment_building_evaluation_formatted <- lemur:::format_measure(apartment_building_evaluation, "apartment_building_evaluation")

lemur:::apartment_building_evaluation_number(apartment_building_evaluation_formatted) %>%
  lemur:::bigger_padded()

lemur:::apartment_building_evaluation_description(level, neighbourhood, apartment_building_evaluation, apartment_building_evaluation_formatted) %>%
  format_paragraph() %>%
  lemur:::bigger_padded()

lemur:::apartment_building_evaluation_plot(dataset, compare, height = distribution_height)
```

## Population change

```{r population-change, opts.label = "distribution", fig.alt = lemur:::population_change_plot_alt_text(level, neighbourhood)}
population_change <- lemur:::get_measure(dataset, "population_change")
population_change_formatted <- lemur:::format_measure(population_change, "population_change")

lemur:::population_change_number(population_change_formatted) %>%
  lemur:::bigger_padded()

lemur:::population_change_description(level, neighbourhood, population_change, population_change_formatted) %>%
  format_paragraph() %>%
  lemur:::bigger_padded()

lemur:::population_change_plot(dataset, compare, height = distribution_height)
```

## Population density

```{r population-density, opts.label = "distribution", fig.alt = lemur:::population_density_plot_alt_text(level, neighbourhood)}
population_density <- lemur:::get_measure(dataset, "population_density")
population_density_formatted <- lemur:::format_measure(population_density, "population_density")

lemur:::population_density_number(population_density_formatted) %>%
  lemur:::bigger_padded()

lemur:::population_density_description(level, neighbourhood, population_density, population_density_formatted) %>%
  format_paragraph() %>%
  lemur:::bigger_padded()

lemur:::population_density_plot(dataset, compare, height = distribution_height)
```

## Household size 

```{r household-size, fig.alt = lemur:::household_size_plot_alt_text(level, neighbourhood), fig.height = 2}
lemur:::household_size_description(level, neighbourhood) %>%
  format_paragraph()

lemur:::household_size_plot(dataset, compare)

lemur:::generate_table(dataset, "household_size", compare, "Household Size", "Percent", output = output)
```

## Average Total Household Income 

```{r average-total-household-income, fig.alt = lemur:::average_total_household_income_plot_alt_text(level, neighbourhood), fig.height = 1}
lemur:::average_total_household_income_description(level, neighbourhood) %>%
  format_paragraph()

lemur:::average_total_household_income_plot(dataset, compare)

lemur:::generate_table(dataset, "average_total_income", compare, "Household Size", "Percent", format = "dollar", output = output)
```

## Unaffordable housing

```{r unaffordable-housing, opts.label = "distribution", fig.alt = lemur:::unaffordable_housing_plot_alt_text(level, neighbourhood)}
unaffordable_housing <- lemur:::get_measure(dataset, "unaffordable_housing")
unaffordable_housing_formatted <- lemur:::format_measure(unaffordable_housing, "unaffordable_housing")

lemur:::unaffordable_housing_number(unaffordable_housing_formatted) %>%
  lemur:::bigger_padded()

lemur:::unaffordable_housing_city(level) %>%
  lemur:::bigger_padded()

lemur:::unaffordable_housing_description(level, neighbourhood, unaffordable_housing, unaffordable_housing_formatted) %>%
  format_paragraph()

lemur:::unaffordable_housing_plot(dataset, compare, height = distribution_height)
```

## Low-income measure after tax

```{r lim-at, opts.label = "distribution", fig.alt = lemur:::lim_at_plot_alt_text(level, neighbourhood)}
lim_at <- lemur:::get_measure(dataset, "lim_at")
lim_at_formatted <- lemur:::format_measure(lim_at, "lim_at")

lemur:::lim_at_number(lim_at_formatted) %>%
  lemur:::bigger_padded()

lemur:::lim_at_city(level) %>%
  lemur:::bigger_padded()

lemur:::lim_at_description(level, neighbourhood, lim_at, lim_at_formatted) %>%
  format_paragraph()

lemur:::lim_at_plot(dataset, compare, height = distribution_height)
```

## Visible minority population

```{r visible-minority, fig.alt = lemur:::visible_minority_plot_alt_text(level, neighbourhood), fig.height = 4}
lemur:::visible_minority_number(dataset) %>%
  lemur:::bigger_padded()

lemur:::visible_minority_city(level) %>%
  lemur:::bigger_padded()

lemur:::visible_minority_description(level, neighbourhood) %>%
  format_paragraph()

lemur:::visible_minority_plot(dataset, compare)

lemur:::generate_table(dataset, "visible_minority", compare, "Visible Minority Group", "Percent", output = output) %>%
  kableExtra::footnote(general = '"n.i.e." = not included elsewhere')
```

## Housing structure type

```{r structure-type, fig.alt = lemur:::structure_type_plot_alt_text(level, neighbourhood), fig.height = 2}
lemur:::structure_type_description(level, neighbourhood) %>%
  format_paragraph()

lemur:::structure_type_plot(dataset, compare)

lemur:::generate_table(dataset, "structure_type", compare, "Housing Structure Type", "Percent", output = output)
```

## Number of bedrooms

```{r bedrooms, fig.alt = lemur:::bedrooms_plot_alt_text(level, neighbourhood), fig.height = 2}
lemur:::bedrooms_description(level, neighbourhood) %>%
  format_paragraph()

lemur:::bedrooms_plot(dataset, compare)

lemur:::generate_table(dataset, "bedrooms", compare, "Housing Structure Type", "Percent", output = output)
```

# Households by tenure

```{r household-tenure, fig.alt = lemur:::household_tenure_plot_alt_text(level, neighbourhood), fig.height = 1}
lemur:::household_tenure_description(level, neighbourhood) %>%
  format_paragraph()

lemur:::household_tenure_plot(dataset, compare)

lemur:::generate_table(dataset, "household_tenure", compare, "Housing Structure Type", "Percent", output = output)
```

## Average shelter cost for renters

```{r shelter-cost, opts.label = "distribution", fig.alt = lemur:::average_renter_shelter_cost_plot_alt_text(level, neighbourhood)}
shelter_cost <- lemur:::get_measure(dataset, "average_renter_shelter_cost")
shelter_cost_formatted <- lemur:::format_measure(shelter_cost, "average_renter_shelter_cost")

lemur:::shelter_cost_number(shelter_cost_formatted) %>%
  lemur:::bigger_padded()

lemur:::shelter_cost_city(level) %>%
  lemur:::bigger_padded()

lemur:::average_renter_shelter_cost_description(level, neighbourhood, shelter_cost, shelter_cost_formatted) %>%
  format_paragraph()

lemur:::average_renter_shelter_cost_plot(dataset, compare, height = distribution_height)
```
