---
params:
  level: neighbourhood
  neighbourhood: South Parkdale
output:
  html_document:
    df_print: paged
    css: ../app/www/style.css
knit: pagedown::chrome_print
---

```{css, echo = FALSE}
:root {
  --base-size: 12px; 
  --bigger-size: 1.1em;
}
```


```{r setup, include=FALSE}
library(lemur)
library(htmltools)
library(knitr)
library(leaflet)
library(mapview)
library(tmap)
library(ceramic)
library(tmaptools)
library(dplyr)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, dpi = 300, out.width = "95%", fig.height = 1.75, fig.align = 'center', cache = FALSE)

level <- params$level
neighbourhood <- params$neighbourhood
compare <- level == "neighbourhood"

title <- switch(level,
  "neighbourhood" = neighbourhood,
  "city" = "City of Toronto"
)

dataset <- lemur:::determine_dataset_from_level(level, neighbourhood)
```

<!-- <div style = "background-color: var(--main-color) !important; color: white; height: 5em; text-align: center;"> -->
# `r title`
<!-- </div> -->

```{r map-alt-text}
map_alt_text <- switch(level,
  neighbourhood = glue::glue("A map of {neighbourhood} showing the locations of apartment buildings, above guideline increase applications, and tenant defense fund grant recipients."),
  city = "A map of Toronto showing the locations of apartment buildings, evictions hearings, above guideline increase applications, and tenant defense fund grant recipients."
)
```

```{r map, fig.height = 3, dpi = 96, out.width = "100%", eval = TRUE}
if (level == "neighbourhood") {
  map_data <- lemur::neighbourhoods %>%
    dplyr::filter(neighbourhood == !!neighbourhood)

  bbox <- tmaptools::bb(map_data, ext = 1.1) %>%
    unname()

  map_buildings <- lemur::buildings %>%
    dplyr::filter(neighbourhood == !!neighbourhood)

  basemap <- cc_location(
    loc = raster::extent(bbox),
    zoom = 14,
    base_url = "https://api.mapbox.com/styles/v1/purposeanalytics/cksw80iwn155y1anq5l1f0v5n/tiles/512/{zoom}/{x}/{y}",
    verbose = FALSE
  )
} else {
  map_data <- lemur::toronto

  bbox <- tmaptools::bb(map_data, ext = 1.1) %>%
    unname()

  map_buildings <- lemur::buildings

  basemap <- cc_location(
    loc = raster::extent(bbox),
    zoom = 9,
    base_url = "https://api.mapbox.com/styles/v1/purposeanalytics/cksw80iwn155y1anq5l1f0v5n/tiles/512/{zoom}/{x}/{y}",
    verbose = FALSE
  )
}

add_circle_layer <- function(map, data, colour, level) {
  if (nrow(data) == 0) {
    return(map)
  }
  
  size <- switch(level, city = 0.1, neighbourhood = 0.25)
  shape <- switch(level, city = 16, neighbourhood = 21)

  map +
    tm_shape(data) +
    tm_symbols(size = size, col = colour, shape = shape, border.col = "white")
}

tm_shape(basemap) +
  tm_rgb() +
  tm_shape(map_data) +
  tm_borders(col = lemur:::main_colour, lwd = 2) %>%
  # Apartment buildings
  add_circle_layer(dplyr::filter(map_buildings, apartment, property_type == "Privately owned"), lemur:::rental_supply_colors()[["Apartment"]], level = level) %>%
  add_circle_layer(dplyr::filter(map_buildings, apartment, property_type == "Toronto Community Housing"), lemur:::rental_supply_colors()[["Toronto Community Housing"]], level = level) %>%
  add_circle_layer(dplyr::filter(map_buildings, apartment, property_type == "Social housing"), lemur:::rental_supply_colors()[["Other Non-Market"]], level = level) %>%
  # Rooming houses
  add_circle_layer(dplyr::filter(map_buildings, rooming_house, rooming_house_status %in% c("Licensed prior to 2018", "Licensed 2018 onwards")), lemur:::amenity_density_colours()[["Low"]], level = level) %>%
  add_circle_layer(dplyr::filter(map_buildings, rooming_house, rooming_house_status == "Lapsed"), lemur:::amenity_density_colours()[["High"]], level = level) %>%
  # AGI
  add_circle_layer(dplyr::filter(map_buildings, agi), lemur:::layer_colours[["agi_apartment"]], level = level) %>%
  # TDF
  add_circle_layer(dplyr::filter(map_buildings, tdf), lemur:::layer_colours[["tdf"]], level = level) +
  tm_add_legend(type = "symbol", labels = c("Apartment buildings", "Above Guideline Increase applications", "Tenant Defense Fund grants"), col = lemur:::layer_colours, shape = 16) +
  tm_layout(legend.bg.color = "white", legend.bg.alpha = 0.5, legend.outside = FALSE, legend.position = c("right", "bottom"), legend.text.fontfamily = "Lato", legend.text.size = 0.5, asp = 2)
```

<div class = "row">

  <div class = "col-sm-6">

## Summary statistics
```{r summary-statistics}
lemur:::summary_statistics_table(dataset)
```
  </div>
  
  <div class = "col-sm-6">
### Estimated supply of low-end of market rental

```{r lem}
dataset[["lem"]] %>%
  kableExtra::kable() %>%
  kableExtra::kable_styling(bootstrap_options = "condensed") %>%
  kableExtra::column_spec(1, width = "30%") %>%
  kableExtra::column_spec(2:4, width = "20%")
```
  </div>
</div>

<hr>

<div class = "row">
  <div class = "col-sm-12">
  
### Estimated rental supply

```{r rental-supply, fig.alt = lemur:::rental_supply_plot_alt_text(level, neighbourhood), fig.height = 0.5}
lemur:::rental_supply_plot(dataset, static = TRUE)
```

  <div class = "row">
  <div class = "col-sm-6">
```{r rental-supply-primary}
lemur:::rental_supply_primary_table(dataset)

```
  </div>
  <div class = "col-sm-6">
```{r rental-supply-secondary-non-market}
lemur:::rental_supply_secondary_table(dataset)
lemur:::rental_supply_non_market_table(dataset)
```
  </div>
  </div>
  </div>

  <div class = "col-sm-5">

  </div>
</div>

<hr>

<div style = "display:block; clear:both; page-break-after:always;"></div>

<div class = "row">
  <div class = "col-sm-6">
### Apartment building units

```{r apartment-building-units, fig.alt = lemur:::number_of_units_plot_alt_text(level, neighbourhood)}
number_of_units <- lemur:::get_measure(dataset, "number_of_units")
number_of_units_formatted <- lemur:::format_measure(number_of_units, "number_of_units")

lemur:::number_of_units_number(number_of_units_formatted) %>%
  lemur:::bigger_padded()

lemur:::number_of_units_breakdown(dataset) %>%
  lemur:::bigger_padded()

lemur:::number_of_units_description(level, neighbourhood, number_of_units, number_of_units_formatted) %>%
  p()

lemur:::number_of_units_plot(dataset, compare, static = TRUE)
```

### RentSafeTO evaluation scores

```{r apartment-building-evaluation, fig.alt = lemur:::apartment_building_evaluation_plot_alt_text(level, neighbourhood)}
apartment_building_evaluation <- lemur:::get_measure(dataset, "apartment_building_evaluation")
apartment_building_evaluation_formatted <- lemur:::format_measure(apartment_building_evaluation, "apartment_building_evaluation")


lemur:::apartment_building_evaluation_number(apartment_building_evaluation_formatted) %>%
  lemur:::bigger_padded()

lemur:::apartment_building_evaluation_description(level, neighbourhood, apartment_building_evaluation, apartment_building_evaluation_formatted) %>%
  p()

lemur:::apartment_building_evaluation_plot(dataset, compare, static = TRUE)
```

### Rooming houses

```{r rooming-houses}
lemur:::display_rooming_houses(dataset, compare = compare)
```

### AGI Applications and TDF Grants

```{r}
lemur:::agi_tdf_description(level, neighbourhood) %>%
  p()

lemur:::display_agi_tdf_buildings(dataset, compare)

lemur:::agi_non_apartments(dataset, level, neighbourhood) %>%
  p()
```
  </div>

  <div class = "col-sm-6">
### Core housing need

```{r core-housing-need, fig.alt = lemur:::core_housing_need_plot_alt_text(level, neighbourhood)}
core_housing_need <- lemur:::get_measure(dataset, "core_housing_need")
core_housing_need_formatted <- lemur:::format_measure(core_housing_need, "core_housing_need")

lemur:::core_housing_need_number(core_housing_need_formatted) %>%
  lemur:::bigger_padded()

lemur:::core_housing_need_description(level, neighbourhood, core_housing_need, core_housing_need_formatted) %>%
  p()

lemur:::core_housing_need_plot(dataset, compare, static = TRUE)
```

### Evictions

```{r evictions, fig.alt = lemur:::evictions_plot_alt_text(level, neighbourhood)}
evictions <- lemur:::get_measure(dataset, "evictions")
evictions_formatted <- lemur:::format_measure(evictions, "evictions")

lemur:::evictions_number(evictions_formatted) %>%
  lemur:::bigger_padded()

lemur:::evictions_description(level, neighbourhood, evictions, evictions_formatted) %>%
  p()

lemur:::evictions_plot(dataset, compare, static = TRUE)
```

### Proximity to services

```{r amenity-density, fig.alt = lemur:::amenity_density_plot_alt_text(level, neighbourhood), fig.height = 1.75}
lemur:::amenity_density_description(level, neighbourhood) %>%
  p()

lemur:::amenity_density_plot(dataset, compare, static = TRUE)

lemur:::generate_table(dataset, "amenity_density", compare, "Proximity to services", "Percent") %>%
  kableExtra::footnote(general = "A very small number of areas have unknown proximity to services, so values may not add up to 100%.")
```
  </div>
</div>

## Housing characteristics 

<div class = "row">
  <div class = "col-sm-6">
### Apartment buildings

```{r apartment-buildings, fig.alt = lemur:::number_of_apartments_plot_alt_text(level, neighbourhood)}
number_of_apartments <- lemur:::get_measure(dataset, "number_of_buildings")
number_of_apartments_formatted <- lemur:::format_measure(number_of_apartments, "number_of_buildings")

lemur:::number_of_apartments_number(number_of_apartments_formatted) %>%
  lemur:::bigger_padded()

lemur:::number_of_apartments_breakdown(dataset) %>%
  lemur:::bigger_padded()

lemur:::number_of_apartments_description(level, neighbourhood, number_of_apartments, number_of_apartments_formatted) %>%
  p()

lemur:::number_of_apartments_plot(dataset, compare, static = TRUE)
```
  
### Housing structure type

```{r structure-type, fig.alt = lemur:::structure_type_plot_alt_text(level, neighbourhood), fig.height = 2}
lemur:::structure_type_description(level, neighbourhood) %>%
  p()

lemur:::structure_type_plot(dataset, compare, static = TRUE)

lemur:::generate_table(dataset, "structure_type", compare, "Housing Structure Type", "Percent")
```

### Average shelter cost for renters

```{r shelter-cost, fig.alt = lemur:::average_renter_shelter_cost_plot_alt_text(level, neighbourhood)}
shelter_cost <- lemur:::get_measure(dataset, "average_renter_shelter_cost")
shelter_cost_formatted <- lemur:::format_measure(shelter_cost, "average_renter_shelter_cost")

lemur:::shelter_cost_number(shelter_cost_formatted) %>%
  lemur:::bigger_padded()

lemur:::shelter_cost_city(level) %>%
  lemur:::bigger_padded()

lemur:::average_renter_shelter_cost_description(level, neighbourhood, shelter_cost, shelter_cost_formatted) %>%
  p()

lemur:::average_renter_shelter_cost_plot(dataset, compare, static = TRUE)
```
  </div>
  
  <div class = "col-sm-6">
### Unaffordable housing

```{r unaffordable-housing, fig.alt = lemur:::unaffordable_housing_plot_alt_text(level, neighbourhood)}
unaffordable_housing <- lemur:::get_measure(dataset, "unaffordable_housing")
unaffordable_housing_formatted <- lemur:::format_measure(unaffordable_housing, "unaffordable_housing")

lemur:::unaffordable_housing_number(unaffordable_housing_formatted) %>%
  lemur:::bigger_padded()

lemur:::unaffordable_housing_city(level) %>%
  lemur:::bigger_padded()

lemur:::unaffordable_housing_description(level, neighbourhood, unaffordable_housing, unaffordable_housing_formatted) %>%
  p()

lemur:::unaffordable_housing_plot(dataset, compare, static = TRUE)
```

### Households by tenure

```{r household-tenure, fig.alt = lemur:::household_tenure_plot_alt_text(level, neighbourhood), fig.height = 1.25}
lemur:::household_tenure_description(level, neighbourhood) %>%
  p()

lemur:::household_tenure_plot(dataset, compare, static = TRUE)

lemur:::generate_table(dataset, "household_tenure", compare, "Housing Structure Type", "Percent")
```

### Number of bedrooms

```{r bedrooms, fig.alt = lemur:::bedrooms_plot_alt_text(level, neighbourhood), fig.height = 2}
lemur:::bedrooms_description(level, neighbourhood) %>%
  p()

lemur:::bedrooms_plot(dataset, compare, static = TRUE)

lemur:::generate_table(dataset, "bedrooms", compare, "Housing Structure Type", "Percent")
```
  </div>
</div>

##
<div style = "display:block; clear:both; page-break-after:always;"></div>

## Sociodemographic characteristics

<div class = "row">
  <div class = "col-sm-6">

### Population density

```{r population-density, fig.alt = lemur:::population_density_plot_alt_text(level, neighbourhood)}
population_density <- lemur:::get_measure(dataset, "population_density")
population_density_formatted <- lemur:::format_measure(population_density, "population_density")

lemur:::population_density_number(population_density_formatted) %>%
  lemur:::bigger_padded()

lemur:::population_density_description(level, neighbourhood, population_density, population_density_formatted) %>%
  p()

lemur:::population_density_plot(dataset, compare, static = TRUE)
```

### Population change

```{r population-change, fig.alt = lemur:::population_change_plot_alt_text(level, neighbourhood)}
population_change <- lemur:::get_measure(dataset, "population_change")
population_change_formatted <- lemur:::format_measure(population_change, "population_change")

lemur:::population_change_number(population_change_formatted) %>%
  lemur:::bigger_padded()

lemur:::population_change_description(level, neighbourhood, population_change, population_change_formatted) %>%
  p()

lemur:::population_change_plot(dataset, compare, static = TRUE)
```

### Average Total Household Income 

```{r average-total-household-income, fig.alt = lemur:::average_total_household_income_plot_alt_text(level, neighbourhood), fig.height = 1.25}
lemur:::average_total_household_income_description(level, neighbourhood) %>%
  p()

lemur:::average_total_household_income_plot(dataset, compare, static = TRUE)

lemur:::generate_table(dataset, "average_total_income", compare, "Household Size", "Percent", format = "dollar")
```

### Low-income measure after tax

```{r lim-at, fig.alt = lemur:::lim_at_plot_alt_text(level, neighbourhood)}
lim_at <- lemur:::get_measure(dataset, "lim_at")
lim_at_formatted <- lemur:::format_measure(lim_at, "lim_at")

lemur:::lim_at_number(lim_at_formatted) %>%
  lemur:::bigger_padded()

lemur:::lim_at_city(level) %>%
  lemur:::bigger_padded()

lemur:::lim_at_description(level, neighbourhood, lim_at, lim_at_formatted) %>%
  p()

lemur:::lim_at_plot(dataset, compare, static = TRUE)
```
  </div>
  <div class = "col-sm-6">

### Household size 

```{r household-size, fig.alt = lemur:::household_size_plot_alt_text(level, neighbourhood), fig.height = 2}
lemur:::household_size_description(level, neighbourhood) %>%
  p()

lemur:::household_size_plot(dataset, compare, static = TRUE)

lemur:::generate_table(dataset, "household_size", compare, "Household Size", "Percent")
```

### Visible minority population

```{r visible-minority, fig.alt = lemur:::visible_minority_plot_alt_text(level, neighbourhood), fig.height = 4}
lemur:::visible_minority_number(dataset) %>%
  p()

lemur:::visible_minority_city(level) %>%
  lemur:::bigger_padded()

lemur:::visible_minority_description(level, neighbourhood) %>%
  p()

lemur:::visible_minority_plot(dataset, compare, static = TRUE)

lemur:::generate_table(dataset, "visible_minority", compare, "Visible Minority Group", "Percent") %>%
  kableExtra::footnote(general = '"n.i.e." = not included elsewhere')
```

  </div>
</div>
